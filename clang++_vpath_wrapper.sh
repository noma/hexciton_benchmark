#!/bin/bash

# Copyright (c) 2021 Matthias Noack (ma.noack.pr@gmail.com)
#
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

# This script is intended to replace clang++ in compilation calls generated by
# the KART library (https//github.com/noma/kart). It expects a clang++ command
# line which:
#     - contains "-c", and
#     - ends with "-o <SRC_FILE>.o <SRC_FILE>.cpp"

#echo "$@"

ARGS=""
SRC_FILE=""
OBJ_FILE=""

# copy command line args without -c, -o, and the source file
for i in "$@"; do
	case $i in
		# remove -c
		-c)
			#ARGS="${ARGS} -S -emit-llvm"	
			;;
		# ommit -o and src file and store file names
		-o)
#			echo "$1 AND $2 ADN $3"
			OBJ_FILE=$2
			SRC_FILE=$3
			break
		;;
		# pass on everything else
		*)
		ARGS="${ARGS} $1"
	esac
	shift # move command line arguments
done

#echo "$ARGS"

SRC_FILE_LL="${SRC_FILE%.cpp}.ll"
SRC_FILE_VPATH_LL="${SRC_FILE%.cpp}_vpath.ll"

echo "... Generating IR ..."

clang++ -S -emit-llvm ${ARGS} -fno-unroll-loops -fno-vectorize -o ${SRC_FILE_LL} ${SRC_FILE}
#clang++ -S -emit-llvm ${ARGS} -o ${SRC_FILE_LL} ${SRC_FILE}

echo "... Running VPath opt pass ..."

# run VPath opt pass on IR and generate new IR
opt ${SRC_FILE_LL} -o ${SRC_FILE_VPATH_LL} -S --loop-vectorize --pass-remarks=loop-vectorize --pass-remarks-missed=loop-vectorize --pass-remarks-analysis=loop-vectorize --enable-vplan-native-path

echo "... Compiling ..."

# compile
clang++ -c ${ARGS} -o ${OBJ_FILE} ${SRC_FILE_VPATH_LL}

echo "... Generating assembly files ..."
ASM_FILE="${SRC_FILE%.cpp}.s"
ASM_FILE_VPATH="${SRC_FILE%.cpp}_vpath.s"
clang++ -S -masm=intel ${ARGS} -o ${ASM_FILE=} ${SRC_FILE_LL}
clang++ -S -masm=intel ${ARGS} -o ${ASM_FILE_VPATH=} ${SRC_FILE_VPATH_LL}

# leave no files, in case of "export KART_KEEP_TMP_FILES=1"
if [ -z ${KART_KEEP_TMP_FILES+x} ]; then
	echo "... Removing temporary *.ll files ..."
	rm -f ${SRC_FILE_LL} ${SRC_FILE_VPATH_LL} ${ASM_FILE} ${ASM_FILE_VPATH}
fi

echo "... Done ..."

